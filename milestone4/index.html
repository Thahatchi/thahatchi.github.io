<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <title>Book Search | IT 4403 Project</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moustache.js/4.2.0/moustache.min.js"></script>
    <style>
        .page-number {
            cursor: pointer;
            padding: 5px 10px;
            margin: 0 2px;
            border: 1px solid #007bff;
            border-radius: 3px;
        }

        .page-number.active {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        /* Grid and List View Styles */
        .result-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
        }
        
        .result-item img {
            max-width: 150px;
            margin-bottom: 10px;
        }

        .grid-view .result-item {
            display: inline-block;
            width: 200px;
        }

        .list-view .result-item {
            display: block;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="bookshelf.html">My Bookshelf</a></li>
        </ul>
    </nav>
    
    <!-- Main Content -->
    <main>
        <h1>Welcome to the Book Search Application</h1>
        
        <!-- Book Search Section -->
        <section id="search-section">
            <input type="text" id="search-input" placeholder="Enter book title or keyword" />
            <button id="search-button">Search</button>
        </section>

        <!-- View Toggle -->
        <section id="view-toggle-section">
            <button id="grid-view-button">Grid View</button>
            <button id="list-view-button">List View</button>
        </section>

        <!-- Results Display Section -->
        <section id="results-section">
            <h2>Search Results</h2>
            <div id="results" class="grid-view"></div> <!-- Default Grid View -->
            <div id="pagination">
                <span id="page-indicator"></span> <!-- Page Indicator -->
            </div>
        </section>

        <!-- Book Details Section -->
        <section id="book-details-section" style="display:none;">
            <h2>Book Details</h2>
            <div id="book-details"></div>
            <button id="save-to-bookshelf" style="display:none;">Save to Bookshelf</button> <!-- Save button -->
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <p>&copy; 2024 Kevin Co. All Rights Reserved.</p>
    </footer>

    <!-- Templates for Moustache.js -->
    <script id="search-result-template" type="x-tmpl-mustache">
        <div class="result-item" data-id="{{id}}" data-title="{{title}}" data-thumbnail="{{thumbnail}}">
            <h3>{{title}}</h3>
            <img src="{{thumbnail}}" alt="{{title}}" />
        </div>
    </script>

    <script id="book-detail-template" type="x-tmpl-mustache">
        <h3>{{title}}</h3>
        <img src="{{thumbnail}}" alt="{{title}}" />
        <p><strong>Authors:</strong> {{authors}}</p>
        <p><strong>Description:</strong> {{description}}</p>
    </script>

    <script>
        $(document).ready(function() {
            let currentPage = 1;
            const resultsPerPage = 10;
            const apiKey = 'AIzaSyC2lPVELazlhLT8Nr66xG_HLruUBHP-CLo'; // Your API Key

            // Function to search for books
            function searchBooks(query, page = 1) {
                const startIndex = (page - 1) * resultsPerPage;
                const url = `https://www.googleapis.com/books/v1/volumes?q=${query}&startIndex=${startIndex}&maxResults=${resultsPerPage}&key=${apiKey}`;

                $.getJSON(url, function(data) {
                    if (data.items) {
                        displayBooks(data.items);
                        setupPagination(data.totalItems, query); // Setup pagination with total items
                    } else {
                        $('#results').empty().append('<p>No results found.</p>');
                        $('#pagination').empty(); // Clear pagination if no results
                        $('#page-indicator').text(''); // Clear page indicator
                    }
                }).fail(function() {
                    $('#results').empty().append('<p>Error retrieving data. Please try again.</p>');
                    $('#pagination').empty(); // Clear pagination on error
                    $('#page-indicator').text(''); // Clear page indicator
                });
            }

            // Function to display books using Moustache.js templates
            function displayBooks(books) {
                $('#results').empty(); // Clear previous results
                const template = $('#search-result-template').html(); // Get the Moustache template
                books.forEach(book => {
                    const title = book.volumeInfo.title || 'No Title';
                    const cover = book.volumeInfo.imageLinks ? book.volumeInfo.imageLinks.thumbnail : 'images/no-image.jpg';
                    const rendered = Mustache.render(template, {
                        id: book.id,
                        title: title,
                        thumbnail: cover
                    });
                    $('#results').append(rendered);
                });

                // Add click event to display book details
                $('.result-item').click(function() {
                    const bookId = $(this).data('id');
                    const title = $(this).data('title');
                    const thumbnail = $(this).data('thumbnail');
                    displayBookDetails(bookId, title, thumbnail);
                });
            }

            // Function to set up pagination
            function setupPagination(totalItems, query) {
                const totalPages = Math.ceil(totalItems / resultsPerPage);
                const maxPageButtons = 5; // Maximum number of pagination buttons
                $('#pagination').empty(); // Clear existing pagination
                $('#page-indicator').text(`Page ${currentPage} of ${totalPages}`); // Update page indicator

                // Calculate the range of pages to display
                const startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
                const endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

                // Adjust start page if endPage is less than maxPageButtons
                if (endPage - startPage < maxPageButtons - 1) {
                    startPage = Math.max(1, endPage - maxPageButtons + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                    const isActive = i === currentPage ? 'active' : '';
                    $('#pagination').append(`<span class="page-number ${isActive}" data-page="${i}">${i}</span>`);
                }
                
                // Add click event to page numbers
                $('.page-number').off('click').on('click', function() { // Unbind previous events
                    currentPage = $(this).data('page'); // Get the page number from the clicked element
                    searchBooks(query, currentPage); // Search with the new page
                });
            }

            // Display detailed information about the selected book
            function displayBookDetails(bookId, title, thumbnail) {
                const apiUrl = `https://www.googleapis.com/books/v1/volumes/${bookId}?key=${apiKey}`;
                $.getJSON(apiUrl, function(data) {
                    $('#book-details').empty();
                    const authors = data.volumeInfo.authors ? data.volumeInfo.authors.join(', ') : 'Unknown Author';
                    const description = data.volumeInfo.description ? data.volumeInfo.description : 'No description available.';
                    const template = $('#book-detail-template').html();
                    const rendered = Mustache.render(template, {
                        title: title,
                        authors: authors,
                        description: description,
                        thumbnail: thumbnail
                    });
                    $('#book-details').append(rendered);
                    $('#book-details-section').show();
                }).fail(function() {
                    $('#book-details').empty().append('<p>Error retrieving book details. Please try again.</p>');
                    $('#book-details-section').show();
                });
            }

            // Search button click event
            $('#search-button').click(function() {
                const query = $('#search-input').val();
                if (query) {
                    currentPage = 1; // Reset to first page
                    searchBooks(query);
                } else {
                    $('#results').empty().append('<p>Please enter a search term.</p>');
                    $('#pagination').empty(); // Clear pagination if no search term
                    $('#page-indicator').text(''); // Clear page indicator
                }
            });

            // Grid/List View Toggle
            $('#grid-view-button').click(function() {
                $('#results').removeClass('list-view').addClass('grid-view');
            });

            $('#list-view-button').click(function() {
                $('#results').removeClass('grid-view').addClass('list-view');
            });
        });
    </script>
</body>
</html>
